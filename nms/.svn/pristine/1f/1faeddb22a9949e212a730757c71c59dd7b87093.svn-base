   /*
   * 初始化树形表格
   */
    initGrid();
    function initGrid()
    {
        $('#grid').datagrid({
       	 columns:[[{
				field : 'ck',
				checkbox : true,
				align : 'center'
			    },
       	   		{field:'partner_symbol',title:'渠道代号',height: 40,width:60,align:'center'},
       	   		{field:'partner_name',title:'渠道名称',height: 40,width:60,align:'center'},
       	   		{field:'parent_partner',title:'上级渠道',height: 40,width:60,align:'center'},
       	   		{field:'login_name',title:'登录名称',height: 40,width:60,align:'center'},
       	   		{field:'other',title:'渠道logo配置',height: 50,width:100,align:'center',
	       	   		formatter : function(value, row, index) {
						return "<button  style=\" border:none;background: transparent; width: 100px;height: 30px;color: blue\" onclick=\"logoConfig(\'"+row.partner_id+"\',\'"+row.partner_symbol+"\')\">渠道logo配置</button>";
					}
       	   		},
       	   		{field:'sync_switch',title:'是否同步',height: 40,width:60,align:'center',
	       	   		formatter : function(value, row, index) {
						if(row.sync_switch==1){
							return "<input type=\"image\" src=\"static/images/gem_okay.png\" onclick=\"changeStatus(\'status\',\'"+row.chapter_id+"\',\'"+row.status+"\',\'"+row.chapter_checked+"\',\'"+row.vip_flag+"\')\"/>";
						}else{
							return "<input type=\"image\" src=\"static/images/gem_remove.png\" onclick=\"changeStatus(\'status\',\'"+row.chapter_id+"\',\'"+row.status+"\',\'"+row.chapter_checked+"\',\'"+row.vip_flag+"\')\"";
						}
					}
       	   		},
       	   		{field:'sync_method',title:'同步方法',height: 40,width:60,align:'center',
	       	   		formatter : function(value, row, index) {
						if(row.sync_method==0){
							return "GET";
						}else{
							return "POST";
						}
					}
       	   		},
       	   		{field:'status',title:'状态',height: 40,width:100,align:'center',
	       	   		formatter : function(value, row, index) {
						if(row.status==0){
							return "<font color='red'>停用</font>";
						}else if(row.status==1){
							return "<font color='green'>可用</font>";
						}else{
							return "<font color='orange'>待审核</font>";
						}
					}
       	   		},
       	   		{field:'sub_partner',title:'子渠道',height: 40,width:100,align:'center',
	       	   		formatter : function(value, row, index) {
/*	       	   			if(row.sub_partner_count==0){
	       	   				return "<font color='gray'>查看子渠道</font>";
	       	   			}else{*/
							var url = "查看子渠道("+row.sub_partner_count+")";
							return "<a href=\"javascript:void(0)\" onclick=\"self.parent." +
							"addTab(\'" + row.partner_symbol + "\',\'partnerInfo/getSubPartner?" +"partner_id=" + row.partner_id 
							+"&parent_id=" + row.parent_id +"\',\'icon-add\')\" \>" +url + "</a>";
	       	   			//}

					}
       	   		},
       	   		{
    				field : 'created_time',
    				title : '创建日期',
    				width : 100,
    				height: 40,
    				align : 'center'
    			}
       	   		]],
           url:'partnerInfo/getAllpartnerInfo',
	   		method : 'post',
			queryParams : {
				partner_name:"",
			},
	   		collapsible : true,
	   		//rownumber列的配置是在全局设置的
	   		//如果设置为true则会在开头第一列来添加一列来显示行号。
	   		rownumbers : false,
	   		//如果为true，则只允许选择一行。
	   		singleSelect : true,
	   		toolbar : '#tb',
	   		fitColumns : true,
	   		pageSize:50,
	   		pageList:[20,50,100],
	   		fitColumns:true,
	   		//pagination:是否启动分页，true，这样一来我们的datagrid底部就会出现一个分页工具栏
	   		//datagrid在请求数据的时候会自动的添加分页的信息：
	   		//page：当前请求的页码
	   		//rows：每页要显示的行数
	   		pagination : true,
	   		onLoadSuccess: function(data) {//加载成功   

           	
           }

       });
    }
    
    $("#search").click(function(e) {
    	var partner_symbol = $("#partner_symbol").val();
    	$('#grid').datagrid('load', {
    		partner_symbol:partner_symbol
    	});
    });
    
    /*
     * 刷新
     */
    
   $("#reload").click(function(e) {

  	 $('#grid').datagrid('load');
     });
   
   /**
    * 新增编辑渠道
    */
   function dialog(parameter) {
   	//title:添加界面的标题
   	//icon:标题的图标
   	//bookid：书id
   	var title = "",parent_id=0,grand_parent_id=0,
   		icon = "",partner_symbol="",
   		partner_id = 0;
   	//隐藏chapter_table		none
   	if (parameter == "add") {
   		title = "新增渠道";
   		icon = "icon-add";
   		$("#add_partner_name").val("");
   		$("#add_login_name").val("");
   		$("#add_password").val("");
   		document.getElementById("add_partner_name").removeAttribute("readOnly");
   		document.getElementById("add_login_name").removeAttribute("readOnly");
   		$("#add_partner_symbol").val(getPartnerSymbol());
   		
   		
   	}else{
   		icon = "icon-edit";
   		title = "编辑渠道";
		var rows = $('#grid').datagrid('getChecked');

		if (rows.length == 1) {
			partner_id = rows[0].partner_id;
	   		$("#add_partner_symbol").val(rows[0].partner_symbol);
	   		$("#add_partner_name").val(rows[0].partner_name);
	   		$("#add_login_name").val(rows[0].login_name);
	   		$("#add_password").val(rows[0].password);
			$("#edit_sync_switch").find("option[value = '" + rows[0].sync_switch + "']").attr("selected", "selected");
			$("#edit_sync_method").find("option[value = '" + rows[0].sync_method + "']").attr("selected", "selected");
			$("#edit_status").find("option[value = '" + rows[0].status + "']").attr("selected", "selected");
			$("#edit_group_id").find("option[value = '" + rows[0].group_id + "']").attr("selected", "selected");

			document.getElementById("add_login_name").setAttribute("readOnly",'true');
		} else if (rows.length == 0) {
			alert_autoClose("请选择一个！", "error");
			return false;
		} else if (rows.length > 1) {
			alert_autoClose("一次只能选择一个！！！", "error");
			return false;
		}
   	}
   	$('#dialog_table').css("display","block");
   	//创建一个对话框
   	$('#dialog').dialog({
   		//title="新增";
   		//icon="icon-add";
   		//对话框窗口标题文本
   		title : title,
   		//
   		iconCls : icon,
   		//定义是否显示可折叠按钮。默认为false
   		collapsible : true,
   		//定义是否显示最大化按钮，默认没false
   		maximizable : true,
   		//定义定义是否可以改变对话框窗口大小。默认为false
   		resizable : true,
   		//窗口宽度
   		width : 450,
   		//窗口高度
   		height : 400,
   		//定义窗口是不是模态（modal）窗口。有遮布
   		modal : true,
   		//定义是否可以关闭窗口
   		closed : false,
   		align : 'center',
   		//定义窗口关闭函数
   		onClose : function() {
   			$('#dialog').dialog('close');
   		},
   		buttons : [ {
   			//定义按钮value值
   			text : '确定',
   			//icon  √
   			iconCls : 'icon-ok',
   			//按钮事件（处理者）
   			handler : function() {
   				var partner_name = $("#add_partner_name").val(),
   					partner_symbol = $("#add_partner_symbol").val(),
   					login_name = $("#add_login_name").val(),
   					password = $("#add_password").val(),
   					sync_switch = $("#edit_sync_switch").val(),
   					sync_method = $("#edit_sync_method").val(),
   					group_id= $("#edit_group_id").val(),
   					status = $("#edit_status").val();
   				if(partner_name.length <= 0) {
   					$("#add_partner_name").tips({
   						//提示消息的显示位置，1234，代表上下左右。默认1.
   						side : 1,
   						//提示内容
   						msg : '渠道名称不能为空!!!!',
   						//字体背景颜色
   						bg : '#FF3C3C',
   						//自动关闭事件
   						time : 3
   					});
   					return false;
   				}
   				if(partner_symbol.length <= 0) {
   					$("#add_partner_symbol").tips({
   						//提示消息的显示位置，1234，代表上下左右。默认1.
   						side : 1,
   						//提示内容
   						msg : '渠道代号不能为空!!!!',
   						//字体背景颜色
   						bg : '#FF3C3C',
   						//自动关闭事件
   						time : 3
   					});
   					return false;
   				}
   				if(login_name.length <= 0) {
   					$("#add_login_name").tips({
   						//提示消息的显示位置，1234，代表上下左右。默认1.
   						side : 1,
   						//提示内容
   						msg : '登录名称不能为空!!!!',
   						//字体背景颜色
   						bg : '#FF3C3C',
   						//自动关闭事件
   						time : 3
   					});
   					return false;
   				}
   				//下面的代码中应用了转义字符"\"输出一个字符"/"
   				var Expression = /[_a-zA-Z0-9]{6,12}/;
   				//创建一个正则表达式对象
   				var objExp = new RegExp(Expression);
   				if (password.length <= 0 || !objExp.test(password)) {
   					$("#add_password").tips({
   						//提示消息的显示位置，1234，代表上下左右。默认1.
   						side : 1,
   						//提示内容
   						msg : '密码为6-12位字母数字，下划线',
   						//字体背景颜色
   						bg : '#FF3C3C',
   						//自动关闭事件
   						time : 3
   					});
   					return false;
   				}

   				$.ajax({
   					//默认值: true。默认设置下，所有请求均为异步请求。如果需要发送同步请求，请将此选项设置为 false。
   					async : false,
   					//默认值: true，dataType 为 script 和 jsonp 时默认为 false。设置为 false 将不缓存此页面。
   					cache : false,
   					type : 'POST',
   					data : {
   						partner_id:partner_id,
   						group_id:group_id,
   						parent_id:parent_id,
   						grand_parent_id:grand_parent_id,
   						partner_symbol:partner_symbol,
   						partner_name:partner_name,
   						login_name:login_name,
   						password:password,
   						sync_switch:sync_switch,
   						sync_method:sync_method,
   						status:status
   					},
   					url : "partnerInfo/addEditPartnerInfo",
   					error : function() { //请求失败处理函数  
   						alert('请求失败');
   					},
   					success : function(data) {

   						var result = data.success;

   						if (result == "10") {
   							//title:窗口标题
   							//信息弹出框，
   							$.messager.show({
   								title : title,
   								msg : title + '成功！',
   								showSpeed : 100,
   								timeout : 1000,
   								showType : 'show',
   								//弹出框的样式。
   								style : {
   									right : '',
   									top : document.body.scrollTop + document.documentElement.scrollCenter,
   									bottom : ''
   								}
   							});
   							//关闭对话框
   							$('#dialog').dialog('close');
   							//更新完刷新表格
   							$('#grid').datagrid('reload');
   						} else if (result == "11") {
   							alert_autoClose(title + "渠道代号已存在", "error");
   							$('#dialog').dialog('close');
   						} else if (result == "12") {
   							alert_autoClose(title + "渠道名称已存在", "error");
   							$('#dialog').dialog('close');
   						} else if (result == "13") {
   							alert_autoClose(title + "登录名称已存在", "error");
   							$('#dialog').dialog('close');
   						} else {
   							alert_autoClose(title + "失败！", "error");
   							$('#dialog').dialog('close');
   						}
   					} //请求成功后处理函数。    
   				}); //Ajax end

   			} //按钮事件end
   		}, //按钮END
   			{
   				text : '取消',
   				iconCls : 'icon-cancel',
   				handler : function() {
   					$('#dialog').dialog('close');
   				}
   			} ]
   	}); //对话框End
   	//窗口居中
   	$('#dialog').window('center');
   }
   function getPartnerSymbol(){
	  var partner_symbol = "";
      $.ajax({  
         async : false,  
         cache:false,  
         type: 'POST', 
         data:{
        	 partner_id:0
         },
         dataType : "json",
         url: "partnerInfo/getPartnerSymbol",
         error: function () {//请求失败处理函数  
        	 alert_autoClose('获取渠道代号失败',"error");
         },  
         success:function(data){
        	 var obj = eval(data);
        	 partner_symbol = obj.partner_symbol;
        	 if(partner_symbol.length==0)
        		 alert_autoClose('获取渠道代号失败',"error");
         } //请求成功后处理函数。    
      }); 
	  return partner_symbol;
   }
  
   /*
    * 删除
    */
   function del(){
	   var rows = $('#grid').datagrid('getSelections'); //获取多行
	   if(rows.length>1){
	 		alert_autoClose("只能选择一行！","error");
	 		return false;
	   }else if(rows.length==0){
	 		alert_autoClose("请选择一个！","error");
	 		return false;
	 	}
		$('#dialog').dialog({
	           title: "删除",
	           iconCls:"sss",
	           content:"确定删除？",
	           collapsible: true,
	           maximizable: true,
	           resizable: true,
	           width: 350,
	           height: 200,
	           modal: true,
	           closed:false,
	           align : 'center',
	           onClose: function () {
	        	   $('#dialog').dialog('close');
	           },
	           buttons: [{
	               text: '确定',
	               iconCls: 'icon-ok',
	               handler: function () {
	            	   $.ajax({  
	            	         async : false,  
	            	         cache:false,  
	            	         type: 'POST',  
	            	         dataType : "json",
	            	         data:{partner_id:rows[0].partner_id},
	            	         url: "partnerInfo/delPartnerInfo",
	            	         error: function () {//请求失败处理函数  
	            	             alert('请求失败');  
	            	         },  
	            	         success:function(data){
	            	        	
	            	        	 var obj = eval(data);
		          	             if(obj.success=="0"){
		          	            	 $('#grid').datagrid('load');
		          	            	 alert_autoClose("删除成功","info");
		          	             }else{
		          	            	 alert_autoClose("删除失败","error"); 
		          	             }

		  	            	   $('#dialog').dialog('close');
	            	         } //请求成功后处理函数。    
	            	     }); 
	               }
	           }, {
	               text: '取消',
	               iconCls: 'icon-cancel',
	               handler: function () {
	                   $('#dialog').dialog('close');
	               }
	           }]
	       });
		   $('#dialog').window('center');
   }
   
   function logoConfig(partner_id,partner_symbol){
      $.ajax({  
          async : false,  
          cache:false,  
          type: 'POST',  
          dataType : "json",
          data:{partner_id:partner_id},
          url: "partnerInfo/getPartnerLogoConfig",
          error: function () {//请求失败处理函数  
         	 alert_autoClose('获取配置失败',"error");
          },  
          success:function(data){
         	 var obj = eval(data);
         	logoConfigDialog(partner_id,partner_symbol,obj.data);
          } //请求成功后处理函数。    
       }); 
   }
   
   //弹出对话框
   function logoConfigDialog(partner_id,partner_symbol,data){
	   
	   var logo_url="",logo_name="",work_time="",id=0
	   qq="",mail="",we_chat="",qr_code_url="",create_time="";
	   if(data!=null){
			$("#add_logo_url").val(data.logo_url);
			$("#add_logo_name").val(data.logo_name);
			$("#add_work_time").val(data.work_time);
			$("#add_qq").val(data.qq);
			$("#add_mail").val(data.mail);
			$("#add_wx_gzh").val(data.we_chat);
			$("#add_wx_qr").val(data.qr_code_url);
			id=data.id;
	   }else{
			$("#add_logo_url").val("http://aaa.com");
			$("#add_logo_name").val("拇指书屋");
			$("#add_work_time").val("9:00-21:00");
			$("#add_qq").val("123456");
			$("#add_mail").val("a@b.com");
			$("#add_wx_gzh").val("拇指书屋");
			$("#add_wx_qr").val("http://aaa.com");
		   id = 0;
	   }
	  	$('#dialog_table_logo').css("display","block");
	   	//创建一个对话框
	   	$('#logo_dialog').dialog({
	   		//title="新增";
	   		//icon="icon-add";
	   		//对话框窗口标题文本
	   		title : "渠道配置-"+partner_symbol,
	   		//
	   		iconCls : "icon-edit",
	   		//定义是否显示可折叠按钮。默认为false
	   		collapsible : true,
	   		//定义是否显示最大化按钮，默认没false
	   		maximizable : true,
	   		//定义定义是否可以改变对话框窗口大小。默认为false
	   		resizable : true,
	   		//窗口宽度
	   		width : 450,
	   		//窗口高度
	   		height : 400,
	   		//定义窗口是不是模态（modal）窗口。有遮布
	   		modal : true,
	   		//定义是否可以关闭窗口
	   		closed : false,
	   		align : 'center',
	   		//定义窗口关闭函数
	   		onClose : function() {
	   			$('#logo_dialog').dialog('close');
	   		},
	   		buttons : [ {
	   			//定义按钮value值
	   			text : '确定',
	   			//icon  √
	   			iconCls : 'icon-ok',
	   			//按钮事件（处理者）
	   			handler : function() {
	   			   logo_url=$("#add_logo_url").val();
	   			   logo_name=$("#add_logo_name").val();
	   			   work_time=$("#add_work_time").val();
	   			   qq=$("#add_qq").val();
	   			   mail=$("#add_mail").val()
	   			   we_chat=$("#add_wx_gzh").val();
	   			   qr_code_url=$("#add_wx_qr").val();
	   		       $.ajax({  
	   		          async : false,  
	   		          cache:false,  
	   		          type: 'POST',  
	   		          dataType : "json",
	   		          data:{
	   		        	id:id,
	   		        	partner_id:partner_id,
		   		    	logo_url:logo_url,
		   		    	logo_name:logo_name,
		   		    	work_time:work_time,
		   		    	qq:qq,
		   		    	mail:mail,
		   		    	we_chat:we_chat,
		   		    	qr_code_url:qr_code_url
	   		    	  },
	   		          url: "partnerInfo/savePartnerLogoConfig",
	   		          error: function () {//请求失败处理函数  
	   		         	 alert_autoClose('请求失败',"error");
	   		          },  
	   		          success:function(data){
	   		         	 var obj = eval(data);
	   		         	 if(obj.success==0){
	   		         		 alert_autoClose('配置成功',"info");
	   		         	 }else{
	   		         		alert_autoClose('配置失败',"error");
	   		         	 }
	   		         	 $('#logo_dialog').dialog('close');
	   		          } //请求成功后处理函数。    
	   		        }); 
	   			   
	   			} //按钮事件end
	   		}, //按钮END
	   			{
	   				text : '取消',
	   				iconCls : 'icon-cancel',
	   				handler : function() {
	   					$('#logo_dialog').dialog('close');
	   				}
	   			} ]
	   	}); //对话框End
	   	//窗口居中
	   	$('#logo_dialog').window('center');
   }
   /*
    * 修改密码
    */
   $("#changePaPwd").click(function(e) {
   	var rows = $('#grid').datagrid('getChecked'); 
   	if(rows.length!=1){
   		alert_autoClose("只能选择一个！","error");
   		return;
   	}
   	var user = rows[0];
   	 $('#pwd_table').css("display","block");
   	 $("#c_n_pwd").val('');
   	 $("#c_r_pwd").val('');
   	$('#dialog-pwd').dialog({
   		title : "修改密码",
   		iconCls :"icon-edit",
   		collapsible : true,
   		maximizable : true,
   		resizable : true,
   		width : 350,
   		height : 350,
   		modal : true,
   		closed : false,
   		align : 'center',
   		onClose : function() {
   			$('#dialog-pwd').dialog('close');
   		},
   		buttons : [ {
   			text : '确定',
   			iconCls : 'icon-ok',
   			handler : function() {
   				var	n_pwd = $("#c_n_pwd").val(),
   					r_pwd = $("#c_r_pwd").val();	
   				if (n_pwd.length <= 0) {
   					$("#c_s_pwd").tips({
   						side : 1,
   						msg : '密码不能为空！',
   						bg : '#FF3C3C',
   						time : 3
   					});
   					return false;
   				}

   				if (n_pwd != r_pwd) {
   					$("#c_n_pwd").tips({
   						side : 1,
   						msg : '两次密码输入不一致！',
   						bg : '#FF3C3C',
   						time : 3
   					});
   					return false;
   				}
   				var md5_npwd = md5(n_pwd);
   				$.ajax({
   					async : false,
   					cache : false,
   					type : 'POST',
   					data : {
   						s_pwd : user.password,
   						n_pwd : md5_npwd,
   						id:user.partner_id,
   						flag:2
   					},
   					url : "partnerInfo/changePaPwd",
   					error : function() { //请求失败处理函数  
   						alert('请求失败');
   					},
   					success : function(data) {
   						var result = data.result;
   						if (result == "20") {
   							alert_autoClose("修改成功！", "info");
   							$('#dialog-pwd').dialog('close');
   						} else if(result == "0") {
   							alert_autoClose("服务器内部错误", "error");
   						} else if(result == "10") {
   							alert_autoClose("用户ID错误", "error");
   						} else if(result == "11") {
   							alert_autoClose("密码验证错误", "error");
   						} else if(result == "12") {
   							alert_autoClose("账号登录错误", "error");
   						} else if(result == "13") {
   							alert_autoClose("没有修改权限", "error");
   						} else if(result == "14") {
   							alert_autoClose("其他错误", "error");
   						}
   					} //请求成功后处理函数。    
   				});

   			}
   		}, {
   			text : '取消',
   			iconCls : 'icon-cancel',
   			handler : function() {
   				$('#dialog-pwd').dialog('close');
   			}
   		} ]
   	});
   	$('#dialog-pwd').window('center');
   });
   /*
    * 提示信息
    */
	
	function alert_autoClose(msg,icon){  
		 var interval;  
		 var time=1000;  
		 var x=2;    //设置时间2s
		$.messager.alert("系统提示",msg,icon,function(){
			
		});  
		 interval=setInterval(fun,time);  
		        function fun(){  
		      --x;  
		      if(x==0){  
		          clearInterval(interval);  
		  $(".messager-body").window('close');    
		       }  
		}; 
		}